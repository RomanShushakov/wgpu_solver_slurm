chmod +x scripts/10_enable_accounting_mariadb_docker.sh
bash scripts/10_enable_accounting_mariadb_docker.sh

chmod +x scripts/11_configure_slurmdbd.sh
bash scripts/11_configure_slurmdbd.sh

chmod +x scripts/12_create_accounts_users.sh
bash scripts/12_create_accounts_users.sh

chmod +x scripts/12_undo_create_accounts_users.sh
bash scripts/12_undo_create_accounts_users.sh



DELETE_LINUX_USER=1 DELETE_HOME=1 DELETE_ACCOUNT=1 bash scripts/12_undo_create_accounts_users.sh
bash scripts/12_create_accounts_users.sh

sudo -u user1 ls -la /home/user1/wgpu_workspace/slurm_logs
sacct -X -j <JOBID> -o JobIDRaw,User,Account,State,Elapsed,AllocCPUS,AllocTRES%40


chmod +x scripts/20_provision_user_workspace.sh
USER_NAME=user1 bash scripts/20_provision_user_workspace.sh


sudo -u user1 -H mkdir -p /home/user1/wgpu_workspace/experiments/cases
sudo rsync -a --delete ./experiments/cases/test/ /home/user1/wgpu_workspace/experiments/cases/test/
sudo chown -R user1:user1 /home/user1/wgpu_workspace/experiments


bash scripts/30_export_usage_json.sh --since "now-24hours" --out ./usage/usage.json


export ROOT_DIR=$HOME/wgpu_workspace

export ROOT_DIR=$HOME/workdir/wgpu_solver_slurm
export CASE_DIR=$ROOT_DIR/experiments/cases/case_3
export OUT_DIR=$ROOT_DIR/experiments/runs/case_3
export BIN=$ROOT_DIR/solvers/wgpu_solver_backend_cli
export IMAGE=$ROOT_DIR/apptainer/solver-runtime.sif

export BACKEND=auto
export MAX_ITERS=2000
export REL_TOL=1e-4
export ABS_TOL=1e-7
export APPTAINER_GPU=""

sbatch \
  --job-name=wgpu_case_3 \
  --partition=local \
  --time=00:10:00 \
  --cpus-per-task=1 \
  --mem=2G \
  --output=slurm-case3-%j.out \
  --error=slurm-case3-%j.err \
  --export=ALL \
  --wrap='
mkdir -p "$OUT_DIR"

apptainer exec $APPTAINER_GPU \
  --bind "$ROOT_DIR:$ROOT_DIR" \
  "$IMAGE" \
  bash -lc "
    set -euo pipefail
    cd \"$ROOT_DIR\"
    \"$BIN\" run-pcg-case \
      --case-dir \"$CASE_DIR\" \
      --max-iters \"$MAX_ITERS\" \
      --rel-tol \"$REL_TOL\" \
      --abs-tol \"$ABS_TOL\" \
      --out-x \"$OUT_DIR/x.bin\" \
      --out-metrics \"$OUT_DIR/metrics.json\"
  "
'
